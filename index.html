<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Тестовая платформа — Supabase</title>

  <style>
    body { font-family: sans-serif; margin: 0; background: #f5f5f5; }
    #app { max-width: 800px; margin: auto; padding: 20px; }
    h1,h2,h3 { margin: 10px 0; }
    button { padding: 6px 12px; margin: 4px; }
    .block { background: white; padding: 12px; margin: 8px 0; border-radius: 6px; }
    .correct { color: green; font-weight: bold; }
    .wrong { color: red; font-weight: bold; }
    .note { margin-top: 6px; font-size: 14px; }
  </style>

  <!-- Подключаем supabase-js -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const SUPABASE_URL = "https://peqqdikmngeswcxvesrt.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBlcXFkaWttbmdlc3djeHZlc3J0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNTk3NDgsImV4cCI6MjA3NDgzNTc0OH0.IZQ0_bT8r2Rw3DjODwdqeqz3wEqVCcMbtaXLbKTTegU";

    export const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ==== Локальное хранилище + синхронизация ====
    const Storage = {
      set(k,v){ localStorage.setItem(k, JSON.stringify(v)); },
      get(k){ return JSON.parse(localStorage.getItem(k)||'null'); }
    };

    async function cloudSet(id, value) {
      const { error } = await supabase
        .from("app")
        .upsert({ id, value, ts: new Date().toISOString() });
      if (error) console.error("Ошибка cloudSet:", error);
    }

    async function cloudGet(id) {
      const { data, error } = await supabase
        .from("app")
        .select("value")
        .eq("id", id)
        .single();
      if (error) { console.error("Ошибка cloudGet:", error); return null; }
      return data?.value ?? null;
    }

    function cloudSubscribe(callback) {
      supabase
        .channel("app-changes")
        .on("postgres_changes",
          { event: "*", schema: "public", table: "app" },
          (payload) => callback(payload.new.id, payload.new.value)
        )
        .subscribe();
    }

    async function initSupabaseCloud() {
      const keys = ["tests","categories","users"];
      for (const k of keys) {
        const val = await cloudGet(k);
        if (val) Storage.set(k, val);
      }
      cloudSubscribe((id,value)=>{
        Storage.set(id,value);
        renderMain();
      });
    }

    // ==== Данные приложения ====
    let AppState = { page: "login", user: null };

    function getTests() { return Storage.get("tests") || []; }
    function saveTests(tests) { Storage.set("tests",tests); cloudSet("tests",tests); }

    // ==== Интерфейс ====
    function el(tag,attrs={},...children){
      const e=document.createElement(tag);
      for(const [k,v] of Object.entries(attrs)){
        if(k==="class") e.className=v;
        else if(k.startsWith("on")) e.addEventListener(k.substring(2),v);
        else e.setAttribute(k,v);
      }
      for(const c of children){
        e.appendChild(typeof c==="string"?document.createTextNode(c):c);
      }
      return e;
    }

    function renderLogin(root){
      root.innerHTML="";
      root.append(
        el("h2",{},"Вход"),
        el("input",{id:"login-username",placeholder:"Логин"}),
        el("input",{id:"login-password",placeholder:"Пароль",type:"password"}),
        el("button",{onclick:()=>{
          const u=document.getElementById("login-username").value;
          const p=document.getElementById("login-password").value;
          if(u==="admin"&&p==="12345"){ AppState.user="admin"; AppState.page="admin"; renderMain(); }
          else { AppState.user="student"; AppState.page="tests"; renderMain(); }
        }},"Войти")
      );
    }

    function renderAdmin(root){
      root.innerHTML="";
      root.append(el("h2",{},"Админка: тесты"));
      const tests=getTests();
      for(let i=0;i<tests.length;i++){
        root.append(
          el("div",{class:"block"},
            el("b",{},tests[i].title),
            el("button",{onclick:()=>{
              tests.splice(i,1);
              saveTests(tests);
              renderMain();
            }},"Удалить")
          )
        );
      }
      root.append(el("button",{onclick:()=>{
        const title=prompt("Название теста?");
        if(!title)return;
        const newTest={title,questions:[
          {q:"2+2=?",options:["3","4","5"],correct:1},
          {q:"Столица Франции?",options:["Берлин","Париж","Рим"],correct:1}
        ]};
        tests.push(newTest);
        saveTests(tests);
        renderMain();
      }},"Добавить тест"));
    }

    function renderTests(root){
      root.innerHTML="";
      root.append(el("h2",{},"Выберите тест"));
      const tests=getTests();
      for(let i=0;i<tests.length;i++){
        root.append(
          el("div",{class:"block"},
            el("b",{},tests[i].title),
            el("button",{onclick:()=>{AppState.page="take";AppState.testIndex=i;AppState.qIndex=0;AppState.score=0;renderMain();}},"Пройти")
          )
        );
      }
    }

    function renderTakeTest(root){
      root.innerHTML="";
      const tests=getTests();
      const test=tests[AppState.testIndex];
      const q=test.questions[AppState.qIndex];

      root.append(el("h2",{},test.title));
      root.append(el("div",{},q.q));

      q.options.forEach((opt,idx)=>{
        root.append(
          el("button",{onclick:()=>{
            if(idx===q.correct){
              AppState.score++;
              alert("Верно!");
            } else {
              alert("Неверно!");
              // Показываем правильный ответ
              const note=el("div",{class:"note"},"Правильный ответ: "+q.options[q.correct]);
              root.append(note);
            }
            AppState.qIndex++;
            if(AppState.qIndex<test.questions.length) renderMain();
            else { alert("Тест закончен! Баллы: "+AppState.score+"/"+test.questions.length); AppState.page="tests"; renderMain(); }
          }},opt)
        );
      });
    }

    function renderMain(){
      const root=document.getElementById("app");
      if(AppState.page==="login") return renderLogin(root);
      if(AppState.page==="admin") return renderAdmin(root);
      if(AppState.page==="tests") return renderTests(root);
      if(AppState.page==="take") return renderTakeTest(root);
    }

    window.addEventListener("load",()=>{initSupabaseCloud(); renderMain();});
  </script>
</head>
<body>
  <div id="app"></div>
</body>
</html>
