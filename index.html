<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Тестовая платформа с логами</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc, setDoc, getDoc, updateDoc, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDr20MYdq_py2L-VkzPE85W7cJM_Yq3cdE",
      authDomain: "fast-circle-448017-j1.firebaseapp.com",
      projectId: "fast-circle-448017-j1",
      storageBucket: "fast-circle-448017-j1.firebasestorage.app",
      messagingSenderId: "438243655967",
      appId: "1:438243655967:web:4b0ec3e85d616559a9302a",
      measurementId: "G-Q8MYZTFP20"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentUser = null;
    let categories = [];

    // ---------- ЛОГИН ----------
    async function login() {
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();

      if (username === "admin" && password === "admin123") {
        currentUser = { username: "admin", role: "admin" };
        showAdminPanel();
        return;
      }

      const userDoc = await getDoc(doc(db, "users", username));
      if (!userDoc.exists()) return alert("Пользователь не найден");

      const user = userDoc.data();
      if (user.password !== password) return alert("Неверный пароль");
      if (!user.active) return alert("Админ ещё не разрешил вход");

      currentUser = { username, role: "student" };

      // сохраняем лог входа
      saveLoginLog(username);

      showStudentPanel();
    }

    async function saveLoginLog(username) {
      try {
        const ipResp = await fetch("https://api.ipify.org?format=json");
        const ipData = await ipResp.json();
        const ip = ipData.ip || "unknown";

        const device = navigator.userAgent;
        const time = new Date().toISOString();

        await addDoc(collection(db, "logs"), {
          username,
          ip,
          device,
          time
        });
      } catch (err) {
        console.error("Ошибка логирования:", err);
      }
    }

    // ---------- АДМИН ----------
    async function addStudent() {
      const login = prompt("Логин студента:");
      const pass = prompt("Пароль студента:");
      if (!login || !pass) return;

      await setDoc(doc(db, "users", login), { password: pass, active: false });
      alert("Студент добавлен. Нужно активировать.");
      loadStudents();
    }

    async function activateStudent(login) {
      await updateDoc(doc(db, "users", login), { active: true });
      loadStudents();
    }

    async function loadStudents() {
      const querySnapshot = await getDocs(collection(db, "users"));
      let out = "";
      querySnapshot.forEach((d) => {
        const u = d.data();
        out += `<li>${d.id} — ${u.active ? "✅ Активен" : "❌ Неактивен"} 
          <button onclick="activateStudent('${d.id}')">Разрешить</button></li>`;
      });
      document.getElementById("students").innerHTML = out;
    }

    async function loadLogs() {
      const querySnapshot = await getDocs(query(collection(db, "logs"), orderBy("time", "desc"), limit(20)));
      let out = "<table border='1' cellpadding='5'><tr><th>Логин</th><th>IP</th><th>Устройство</th><th>Время</th></tr>";
      querySnapshot.forEach((d) => {
        const log = d.data();
        out += `<tr><td>${log.username}</td><td>${log.ip}</td><td>${log.device}</td><td>${new Date(log.time).toLocaleString()}</td></tr>`;
      });
      out += "</table>";
      document.getElementById("logs").innerHTML = out;
    }

    async function loadCategoriesAdmin() {
      const querySnapshot = await getDocs(collection(db, "categories"));
      categories = [];
      let out = "";
      querySnapshot.forEach((d) => {
        categories.push(d.data().name);
        out += `<li>${d.data().name}</li>`;
      });
      document.getElementById("categoriesAdmin").innerHTML = out;

      const select = document.getElementById("categorySelect");
      select.innerHTML = categories.map(c => `<option value="${c}">${c}</option>`).join("");
    }

    async function addCategory() {
      const name = prompt("Введите название категории:");
      if (!name) return;
      await addDoc(collection(db, "categories"), { name });
      loadCategoriesAdmin();
    }

    async function addTestFromText() {
      const raw = document.getElementById("testText").value.trim();
      const title = prompt("Название теста:");
      const category = document.getElementById("categorySelect").value;
      if (!raw || !title || !category) return;

      const questions = parseTestText(raw);
      await addDoc(collection(db, "tests"), { title, category, questions });

      alert("Тест сохранён");
      document.getElementById("testText").value = "";
    }

    function parseTestText(text) {
      const blocks = text.split(/\n\s*\n/);
      let questions = [];
      blocks.forEach(block => {
        const lines = block.trim().split("\n");
        if (lines.length < 2) return;
        const qText = lines[0].replace(/^\d+\)\s*/, "").trim();
        let options = [];
        let correct = 0;
        lines.slice(1).forEach((line, idx) => {
          let opt = line.replace(/^-/, "").trim();
          if (opt.endsWith("*")) {
            opt = opt.replace("*", "").trim();
            correct = idx;
          }
          options.push(opt);
        });
        questions.push({ text: qText, options, correct });
      });
      return questions;
    }

    // ---------- СТУДЕНТ ----------
    async function loadCategories() {
      const querySnapshot = await getDocs(collection(db, "categories"));
      let out = "";
      querySnapshot.forEach((docu) => {
        const data = docu.data();
        out += `<li>${data.name} <button onclick="loadTests('${data.name}')">Открыть</button></li>`;
      });
      document.getElementById("categories").innerHTML = out;
    }

    async function loadTests(category) {
      const querySnapshot = await getDocs(collection(db, "tests"));
      let out = `<h3>${category}</h3>`;
      querySnapshot.forEach((docu) => {
        const data = docu.data();
        if (data.category === category) {
          out += `<li>${data.title} <button onclick="takeTest('${docu.id}')">Пройти</button></li>`;
        }
      });
      document.getElementById("tests").innerHTML = out;
    }

    async function takeTest(id) {
      const docu = await getDoc(doc(db, "tests", id));
      if (!docu.exists()) return;
      const data = docu.data();

      let html = `<h3>${data.title}</h3>`;
      data.questions.forEach((q, idx) => {
        html += `<p>${q.text}</p>`;
        q.options.forEach((opt, i) => {
          html += `<label><input type="radio" name="q${idx}" value="${i}">${opt}</label><br>`;
        });
      });
      html += `<button onclick="submitTest('${id}')">Отправить</button>`;
      document.getElementById("tests").innerHTML = html;
    }

    async function submitTest(id) {
      const docu = await getDoc(doc(db, "tests", id));
      if (!docu.exists()) return;
      const data = docu.data();

      let score = 0;
      data.questions.forEach((q, idx) => {
        const ans = document.querySelector(`input[name=q${idx}]:checked`);
        if (ans && Number(ans.value) === q.correct) score++;
      });

      alert(`Ваш результат: ${score} из ${data.questions.length}`);
    }

    // ---------- UI ----------
    function showAdminPanel() {
      document.getElementById("loginForm").style.display = "none";
      document.getElementById("adminPanel").style.display = "block";
      loadStudents();
      loadCategoriesAdmin();
      loadLogs();
    }

    function showStudentPanel() {
      document.getElementById("loginForm").style.display = "none";
      document.getElementById("studentPanel").style.display = "block";
      loadCategories();
    }

    // Глобальные функции
    window.login = login;
    window.addStudent = addStudent;
    window.activateStudent = activateStudent;
    window.addTestFromText = addTestFromText;
    window.loadStudents = loadStudents;
    window.loadCategories = loadCategories;
    window.loadTests = loadTests;
    window.takeTest = takeTest;
    window.submitTest = submitTest;
    window.addCategory = addCategory;
    window.loadLogs = loadLogs;
  </script>
</head>
<body>
  <h1>Тестовая платформа</h1>

  <!-- Логин -->
  <div id="loginForm">
    <input id="username" placeholder="Логин"><br>
    <input id="password" type="password" placeholder="Пароль"><br>
    <button onclick="login()">Войти</button>
  </div>

  <!-- Админ -->
  <div id="adminPanel" style="display:none">
    <h2>Админ-панель</h2>
    <button onclick="addStudent()">Добавить студента</button>
    <h3>Студенты:</h3>
    <ul id="students"></ul>

    <h3>Категории:</h3>
    <ul id="categoriesAdmin"></ul>
    <button onclick="addCategory()">Добавить категорию</button>

    <h3>Добавить тест текстом</h3>
    <textarea id="testText" rows="10" cols="50" placeholder="1) Вопрос\n- Вариант\n- Правильный *"></textarea><br>
    <label>Категория:
      <select id="categorySelect"></select>
    </label><br>
    <button onclick="addTestFromText()">Сохранить тест</button>

    <h3>Логи входов студентов</h3>
    <div id="logs"></div>
  </div>

  <!-- Студент -->
  <div id="studentPanel" style="display:none">
    <h2>Категории</h2>
    <ul id="categories"></ul>
    <div id="tests"></div>
  </div>
</body>
</html>
