<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Тестовая платформа</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; margin: 0; padding: 0; }
    .container { max-width: 800px; margin: auto; padding: 20px; }
    .card { background: #fff; padding: 20px; margin-top: 20px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    h2 { margin-top: 0; }
    input, textarea, select, button { width: 100%; margin: 8px 0; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
    button { background: #4CAF50; color: white; border: none; cursor: pointer; }
    button:hover { background: #45a049; }
    .hidden { display: none; }
    .list { margin: 10px 0; }
    .list-item { padding: 6px; border-bottom: 1px solid #eee; }
  </style>
</head>
<body>
<div class="container">

  <!-- Вход -->
  <div id="login" class="card">
    <h2>Вход</h2>
    <input id="login-username" placeholder="Логин">
    <input id="login-password" type="password" placeholder="Пароль">
    <button onclick="handleLogin()">Войти</button>
  </div>

  <!-- Админ -->
  <div id="admin" class="card hidden">
    <h2>Админ-панель</h2>
    <button onclick="showSection('users')">Управление пользователями</button>
    <button onclick="showSection('tests')">Редактор тестов</button>
    <button onclick="logout()">Выйти</button>

    <!-- Управление пользователями -->
    <div id="section-users" class="hidden">
      <h3>Пользователи</h3>
      <input id="newUser" placeholder="Логин студента">
      <input id="newPass" type="password" placeholder="Пароль студента">
      <button onclick="addUser()">Добавить</button>
      <div id="usersList" class="list"></div>
    </div>

    <!-- Редактор тестов -->
    <div id="section-tests" class="hidden">
      <h3>Редактор тестов</h3>
      <input id="category" placeholder="Категория (например, Математика)">
      <textarea id="testInput" rows="8" placeholder="1) Вопрос?\n- Ответ 1\n- Ответ 2 *\n- Ответ 3"></textarea>
      <button onclick="saveTest()">Сохранить тест</button>
      <div id="testsList" class="list"></div>
    </div>
  </div>

  <!-- Студент -->
  <div id="student" class="card hidden">
    <h2>Тесты</h2>
    <div id="studentTests"></div>
    <button onclick="logout()">Выйти</button>
  </div>

</div>

<script>
// ============ Настройки =============
const ADMIN = { username: "admin", password: "admin123" };
localforage.config({ name: "TestPlatform" });

// ============ Авторизация ============
let currentUser = null;

async function handleLogin() {
  const u = document.getElementById("login-username").value.trim();
  const p = document.getElementById("login-password").value.trim();

  if (u === ADMIN.username && p === ADMIN.password) {
    currentUser = { username: u, isAdmin: true };
    showAdmin();
    return;
  }

  const users = (await localforage.getItem("users")) || [];
  const found = users.find(x => x.username === u && x.password === p);
  if (found && found.active) {
    currentUser = { username: u, isAdmin: false };
    showStudent();
  } else {
    alert("Неверные данные или доступ запрещён");
  }
}

function logout() {
  currentUser = null;
  document.querySelectorAll(".card").forEach(c => c.classList.add("hidden"));
  document.getElementById("login").classList.remove("hidden");
}

// ============ Админ ============

function showAdmin() {
  document.querySelectorAll(".card").forEach(c => c.classList.add("hidden"));
  document.getElementById("admin").classList.remove("hidden");
  showUsers();
  showTests();
}

function showSection(name) {
  document.querySelectorAll("#admin > div").forEach(s => s.classList.add("hidden"));
  document.getElementById("section-" + name).classList.remove("hidden");
}

// --- Пользователи ---
async function addUser() {
  const u = document.getElementById("newUser").value.trim();
  const p = document.getElementById("newPass").value.trim();
  if (!u || !p) return alert("Введите логин и пароль");
  let users = (await localforage.getItem("users")) || [];
  if (users.some(x => x.username === u)) return alert("Пользователь уже есть");
  users.push({ username: u, password: p, active: true });
  await localforage.setItem("users", users);
  document.getElementById("newUser").value = "";
  document.getElementById("newPass").value = "";
  showUsers();
}

async function toggleUser(u) {
  let users = (await localforage.getItem("users")) || [];
  users = users.map(x => x.username === u ? {...x, active: !x.active} : x);
  await localforage.setItem("users", users);
  showUsers();
}

async function deleteUser(u) {
  let users = (await localforage.getItem("users")) || [];
  users = users.filter(x => x.username !== u);
  await localforage.setItem("users", users);
  showUsers();
}

async function showUsers() {
  const users = (await localforage.getItem("users")) || [];
  const list = document.getElementById("usersList");
  list.innerHTML = "";
  users.forEach(u => {
    const div = document.createElement("div");
    div.className = "list-item";
    div.textContent = `${u.username} (${u.active ? "разрешён" : "запрещён"})`;
    div.innerHTML += ` <button onclick="toggleUser('${u.username}')">Переключить</button>
                       <button onclick="deleteUser('${u.username}')">Удалить</button>`;
    list.appendChild(div);
  });
}

// --- Тесты ---
function parseTest(text) {
  const lines = text.split("\n").map(l => l.trim()).filter(l => l);
  let q = null, tests = [];
  lines.forEach(line => {
    if (/^\d+\)/.test(line)) {
      if (q) tests.push(q);
      q = { text: line.replace(/^\d+\)\s*/, ""), options: [], correct: -1 };
    } else if (line.startsWith("-")) {
      let opt = line.replace(/^-/, "").trim();
      if (opt.endsWith("*")) {
        opt = opt.replace("*", "").trim();
        q.correct = q.options.length;
      }
      q.options.push(opt);
    }
  });
  if (q) tests.push(q);
  return tests;
}

async function saveTest() {
  const cat = document.getElementById("category").value.trim();
  const text = document.getElementById("testInput").value.trim();
  if (!cat || !text) return alert("Введите категорию и тест");
  const parsed = parseTest(text);
  let tests = (await localforage.getItem("tests")) || {};
  if (!tests[cat]) tests[cat] = [];
  tests[cat].push({ title: "Тест " + (tests[cat].length+1), questions: parsed });
  await localforage.setItem("tests", tests);
  document.getElementById("testInput").value = "";
  showTests();
}

async function showTests() {
  const tests = (await localforage.getItem("tests")) || {};
  const list = document.getElementById("testsList");
  list.innerHTML = "";
  Object.keys(tests).forEach(cat => {
    const div = document.createElement("div");
    div.className = "list-item";
    div.textContent = `${cat}: ${tests[cat].length} тестов`;
    list.appendChild(div);
  });
}

// ============ Студент ============
async function showStudent() {
  document.querySelectorAll(".card").forEach(c => c.classList.add("hidden"));
  document.getElementById("student").classList.remove("hidden");
  const tests = (await localforage.getItem("tests")) || {};
  const area = document.getElementById("studentTests");
  area.innerHTML = "";
  Object.keys(tests).forEach(cat => {
    const btn = document.createElement("button");
    btn.textContent = "Категория: " + cat;
    btn.onclick = () => takeTest(cat, tests[cat][0]);
    area.appendChild(btn);
  });
}

function takeTest(cat, test) {
  const area = document.getElementById("studentTests");
  area.innerHTML = `<h3>${test.title} (${cat})</h3>`;
  test.questions.forEach((q,i)=>{
    const div = document.createElement("div");
    div.innerHTML = `<p><b>${i+1}. ${q.text}</b></p>` +
      q.options.map((o,j)=>`<label><input type="radio" name="q${i}" value="${j}"> ${o}</label><br>`).join("");
    area.appendChild(div);
  });
  const btn = document.createElement("button");
  btn.textContent = "Сдать";
  btn.onclick = () => {
    let score=0;
    test.questions.forEach((q,i)=>{
      const checked=document.querySelector(`input[name=q${i}]:checked`);
      if(checked && parseInt(checked.value)===q.correct) score++;
    });
    alert(`Результат: ${score} из ${test.questions.length}`);
    showStudent();
  };
  area.appendChild(btn);
}
</script>
</body>
</html>
