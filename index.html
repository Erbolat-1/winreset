<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Система тестирования</title>
  <style>
    body, html {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
      font-family: Arial, sans-serif;
      color: white;
      background: black;
      overflow: hidden;
    }

    /* Фон canvas */
    #stars {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: -1;
    }

    #app {
      position: relative;
      z-index: 1;
      padding: 20px;
      background: rgba(0,0,0,0.6);
      border-radius: 12px;
      max-width: 800px;
      margin: 50px auto;
    }

    h2 { margin-top: 0; }

    .hidden { display: none; }

    .muted { color: #aaa; font-size: 0.9em; }

    ol { padding-left: 20px; }
    li { margin-bottom: 12px; }
    li label { display: block; margin-left: 12px; }
  </style>
</head>
<body>
  <canvas id="stars"></canvas>
  <div id="app"></div>

  <script>
    // ====== Фон "звёздное небо" ======
    const canvas = document.getElementById('stars');
    const ctx = canvas.getContext('2d');
    let stars = [];
    let w, h;

    function resize() {
      w = canvas.width = window.innerWidth;
      h = canvas.height = window.innerHeight;
      stars = Array.from({length: 200}, () => ({
        x: Math.random() * w,
        y: Math.random() * h,
        z: Math.random() * w
      }));
    }
    window.addEventListener('resize', resize);
    resize();

    function drawStars() {
      ctx.fillStyle = 'black';
      ctx.fillRect(0, 0, w, h);
      ctx.fillStyle = 'white';
      stars.forEach(star => {
        star.z -= 2;
        if (star.z <= 0) star.z = w;
        let k = 128.0 / star.z;
        let sx = star.x * k + w/2;
        let sy = star.y * k + h/2;
        if (sx >= 0 && sx <= w && sy >= 0 && sy <= h) {
          let size = (1 - star.z / w) * 2;
          ctx.fillRect(sx, sy, size, size);
        }
      });
      requestAnimationFrame(drawStars);
    }
    drawStars();

    // ====== Данные ======
    const ADMIN = { username: "admin", password: "admin123" };
    let users = JSON.parse(localStorage.getItem("users") || "[]");
    let tests = JSON.parse(localStorage.getItem("tests") || "[]");
    let currentUser = null;

    // ====== Утилиты ======
    function saveData() {
      localStorage.setItem("users", JSON.stringify(users));
      localStorage.setItem("tests", JSON.stringify(tests));
    }

    function $(id) { return document.getElementById(id); }

    function renderLogin() {
      const app = $("app");
      app.innerHTML = `
        <h2>Авторизация</h2>
        <input id="login-username" placeholder="Логин"><br><br>
        <input id="login-password" type="password" placeholder="Пароль"><br><br>
        <button onclick="handleLogin()">Войти</button>
      `;
    }

    function handleLogin() {
      const username = $("login-username").value;
      const password = $("login-password").value;

      if (username === ADMIN.username && password === ADMIN.password) {
        currentUser = { username: "admin", role: "admin" };
        renderAdmin();
      } else {
        const user = users.find(u => u.username === username && u.password === password);
        if (user) {
          currentUser = user;
          renderStudent();
        } else {
          alert("Неверные данные");
        }
      }
    }

    // ====== Админ ======
    function renderAdmin() {
      const app = $("app");
      app.innerHTML = `
        <h2>Админ-панель</h2>
        <button onclick="renderCreateUser()">Создать пользователя</button>
        <button onclick="renderCreateTest()">Создать тест</button>
        <button onclick="renderHome()">Домой</button>
      `;
    }

    function renderCreateUser() {
      const app = $("app");
      app.innerHTML = `
        <h2>Создание пользователя</h2>
        <input id="new-username" placeholder="Логин"><br><br>
        <input id="new-password" type="password" placeholder="Пароль"><br><br>
        <button onclick="createUser()">Создать</button>
        <button onclick="renderAdmin()">Назад</button>
      `;
    }

    function createUser() {
      const username = $("new-username").value;
      const password = $("new-password").value;
      if (!username || !password) { alert("Заполните поля"); return; }
      users.push({ username, password, role: "student" });
      saveData();
      alert("Пользователь создан");
      renderAdmin();
    }

    function renderCreateTest() {
      const app = $("app");
      app.innerHTML = `
        <h2>Создание теста</h2>
        <textarea id="test-text" rows="10" style="width:100%" placeholder="Вопросы и ответы в формате:&#10;1) Вопрос&#10;- Ответ&#10;- Правильный ответ *"></textarea><br><br>
        <button onclick="createTest()">Сохранить</button>
        <button onclick="renderAdmin()">Назад</button>
      `;
    }

    function createTest() {
      const raw = $("test-text").value.trim();
      if (!raw) { alert("Введите текст теста"); return; }
      tests.push({ text: raw });
      saveData();
      alert("Тест сохранён");
      renderAdmin();
    }

    // ====== Студент ======
    function renderStudent() {
      const app = $("app");
      app.innerHTML = `<h2>Доступные тесты</h2>`;
      if (tests.length === 0) {
        app.innerHTML += `<p class="muted">Пока нет тестов</p>`;
      } else {
        tests.forEach((t, i) => {
          const btn = document.createElement("button");
          btn.textContent = "Тест " + (i+1);
          btn.onclick = () => startTest(t.text);
          app.appendChild(document.createElement("br"));
          app.appendChild(btn);
        });
      }
    }

    function startTest(text) {
      const app = $("app");
      const lines = text.split("\n").map(l => l.trim()).filter(l => l);
      let html = "<h2>Тест</h2><ol>";
      lines.forEach(line => {
        if (line.match(/^\d+\)/)) {
          html += `<li>${line.replace(/^\d+\)\s*/, "")}</li>`;
        } else if (line.startsWith("-")) {
          html += `<li style="list-style:none;"><label>${line}</label></li>`;
        }
      });
      html += "</ol><button onclick='renderStudent()'>Назад</button>";
      app.innerHTML = html;
    }

    // ====== Домой ======
    function renderHome() {
      const app = $("app");
      if (!currentUser) {
        renderLogin();
      } else if (currentUser.role === "admin") {
        renderAdmin();
      } else {
        renderStudent();
      }
    }

    renderHome();
  </script>
</body>
</html>
