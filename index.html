<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Платформа тестирования — demo (Supabase sync)</title>

<!-- Supabase JS (v2 compatible) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>

<style>
  /* (тут твой CSS — сокращён для компактности, залишил оригинальные стили) */
  :root{ --bg:#ffffff; --card:#fff; --accent:#2563eb; --muted:#6b7280; --border:#e6eefc }
  html,body{height:100%}
  body{font-family:Inter,system-ui,Arial;margin:0;background:linear-gradient(180deg,#fbfdff 0%,#fff 100%);color:#111}
  .wrap{max-width:1100px;margin:20px auto;padding:18px}
  .card{background:var(--card);border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(15,23,42,0.06);border:1px solid #f3f6fb}
  button{cursor:pointer;border:0;background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px}
  input,textarea,select{width:100%;padding:8px;border-radius:8px;border:1px solid var(--border)}
  .small{font-size:13px;color:var(--muted)}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:8px;border-bottom:1px solid #f1f5f9;font-size:14px;text-align:left}
  .muted{color:var(--muted)}
  .note-block{margin-top:10px;font-size:13px;color:var(--muted)}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Платформа тестирования — демо (Supabase sync)</h1>
      <div class="small muted">Авторизация через Supabase, синхронизация таблицы <code>app</code>.</div>
    </div>
    <div id="main" class="card" style="margin-top:12px"></div>
    <div class="note-block">Инструкции по настройке Supabase — см. комментарии в коде.</div>
  </div>

<script>
/* ===================== Конфиг Supabase =====================
   ЗАМЕНИТЕ на свои значения из Settings → API в Supabase
   ========================================================= */
const SUPABASE_URL = "YOUR_SUPABASE_URL";        // пример: https://xyzabc.supabase.co
const SUPABASE_ANON_KEY = "YOUR_SUPABASE_ANON_KEY";

/* === Подключаем Supabase === */
const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ===================== local storage adapter ===================== */
/* Если используешь localForage, подключи его в html и код ниже его использует автоматически */
const Storage = (function(){
  if (window.localforage) {
    return {
      async get(k){ return await localforage.getItem(k) },
      async set(k,v){ return await localforage.setItem(k,v) },
      async remove(k){ return await localforage.removeItem(k) }
    }
  } else {
    return {
      async get(k){ try { return JSON.parse(localStorage.getItem(k)); } catch(e){ return null } },
      async set(k,v){ localStorage.setItem(k, JSON.stringify(v)); },
      async remove(k){ localStorage.removeItem(k); }
    }
  }
})();

/* Сохраним оригинальные методы для внутреннего использования */
const _storageSet = Storage.set.bind(Storage);
const _storageGet = Storage.get.bind(Storage);
const _storageRemove = Storage.remove.bind(Storage);

/* Небольшая in-memory view поверх localStorage (как в твоём коде) */
const DB = {
  get(key){ try { return JSON.parse(localStorage.getItem(key)) || null } catch(e){ return null } },
  set(key, val){ localStorage.setItem(key, JSON.stringify(val)); },
  async getAsync(key){ return await Storage.get(key) },
  async setAsync(key, val){ return await Storage.set(key, val) },
  remove(key){ localStorage.removeItem(key) }
};

/* =========== Перекроем Storage.set — теперь локально + push в Supabase =========== */
Storage.set = async function(key, value) {
  // 1) записать локально
  await _storageSet(key, value);

  // 2) попытаться записать в Supabase таблицу public.app
  try {
    // upsert: key - primary key, value jsonb, ts
    const payload = { key: key, value: value, ts: new Date().toISOString() };
    const { data, error } = await supabase
      .from('app')
      .upsert(payload, { onConflict: 'key' });

    if (error) {
      console.warn('Supabase upsert error', error);
    } else {
      // console.log('Supabase upsert ok', data);
    }
  } catch (e) {
    console.warn('Supabase write failed', e);
  }
};

/* =========== Подписка на realtime-изменения таблицы app =========== */
/* Supabase Realtime v2: используем channel + postgres_changes */
let supabaseChannel = null;
function subscribeToApp() {
  try {
    if (!supabaseChannel) {
      supabaseChannel = supabase.channel('public:app')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'app' }, payload => {
          // payload: { eventType, new, old }
          try {
            const rec = payload.record || payload.new || payload;
            const key = rec.key;
            const value = rec.value;
            // сравниваем с локальным
            const local = DB.get(key);
            const localStr = JSON.stringify(local);
            const cloudStr = JSON.stringify(value);
            if (localStr !== cloudStr) {
              DB.set(key, value);
              localStorage.setItem(key, JSON.stringify(value));
              console.log('Supabase -> local sync:', key);
              // перерисуем UI, если есть renderMain
              try { if (typeof renderMain === 'function') renderMain(); } catch(e) {}
            }
          } catch(e){ console.warn('payload handle err', e); }
        })
        .subscribe((status) => {
          console.log('Supabase channel status', status);
        });
    }
  } catch(e){ console.warn('subscribe error', e); }
}

/* ===================== initial load from Supabase ===================== */
async function initialLoadFromSupabase(){
  try {
    // получим все строки
    const { data, error } = await supabase.from('app').select('key,value,ts');
    if (error) {
      console.warn('Supabase select error', error);
      return;
    }
    if (Array.isArray(data)) {
      for (const r of data) {
        try {
          const local = DB.get(r.key);
          if (!local) {
            DB.set(r.key, r.value);
            localStorage.setItem(r.key, JSON.stringify(r.value));
            console.log('Seed local from supabase:', r.key);
          }
        } catch(e){}
      }
    }
  } catch(e){ console.warn('initialLoad err', e); }
}

/* ===================== Остальная логика приложения (все функции из твоего кода) ===================== */

/* ---------- Password hash (SHA-256) ---------- */
async function hashHex(password){
  try {
    const enc = new TextEncoder();
    const data = enc.encode(password);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2,'0')).join('');
  } catch(e){
    return btoa(password);
  }
}

/* --------- Storage wrappers / helpers (используй Storage.get/set) ---------- */
function loadUsers(){ return DB.get('users') || [] }
async function saveUsersAsync(users){ DB.set('users', users); await Storage.set('users', users); }
function loadTests(){ return DB.get('tests') || {} }
async function saveTestsAsync(tests){ DB.set('tests', tests); await Storage.set('tests', tests); }
function loadCategories(){ return DB.get('categories') || [] }
async function saveCategoriesAsync(cats){ DB.set('categories', cats); await Storage.set('categories', cats); }
function appendLog(entry){ const logs = DB.get('logs') || []; logs.push(entry); DB.set('logs', logs); localStorage.setItem('logs', JSON.stringify(logs)); Storage.set('logs', logs).catch(()=>{}); }

/* ---------- AppState and UI utilities (упрощено — твой оригинальный UI можно вставить сюда) ---------- */
let AppState = { page:'home', currentUser:null, selectedCategory:null, selectedTestId:null };

/* Небольшие DOM-утилиты (как в твоём коде) */
function el(tag, props={}, children=''){
  const node = document.createElement(tag);
  for(const k in props){
    if(k==='class') node.className = props[k];
    else if(k==='html') node.innerHTML = props[k];
    else node.setAttribute(k, props[k]);
  }
  if(typeof children === 'string') node.appendChild(document.createTextNode(children));
  else if(Array.isArray(children)) children.forEach(c=> node.appendChild(c));
  else if(children instanceof Node) node.appendChild(children);
  return node;
}

/* Minimal UI: home/login/admin/test list/take test — используй/подставь свой код сюда.
   Ниже я вставил минимальный интерфейс, чтобы можно было проверить авторизацию и синхро. */

/* renderNav + renderMain simplified (вставь сюда свой полнофункциональный renderMain/render* из оригинала) */
function renderNav(){
  const root = document.getElementById('main');
  // we will re-render full main after nav actions
}

async function renderMain(){
  const root = document.getElementById('main');
  root.innerHTML = '';

  const header = el('div', { class:'card' });
  const info = AppState.currentUser ? `Пользователь: ${AppState.currentUser.email || AppState.currentUser.username}` : 'Гость (войдите)';
  header.appendChild(el('div', { class:'small muted' }, info));
  root.appendChild(header);

  // simple login form (supabase auth)
  if(!AppState.currentUser){
    const box = el('div', { style:'margin-top:12px' });
    box.appendChild(el('h3', {}, 'Вход через Supabase'));
    const email = el('input', { placeholder:'Email' });
    const password = el('input', { type:'password', placeholder:'Пароль' });
    const btn = el('button', {}, 'Войти');
    const note = el('div', { class:'note-block' });
    btn.onclick = async ()=>{
      try {
        const { error, data } = await supabase.auth.signInWithPassword({ email: email.value.trim(), password: password.value });
        if (error) { note.innerText = 'Ошибка входа: '+error.message; return; }
        // запросим профиль роль
        const user = data.user;
        const { data:profile, error:profErr } = await supabase.from('profiles').select('username,role').eq('id', user.id).single();
        AppState.currentUser = { id: user.id, email: user.email, username: profile ? profile.username : user.email, role: profile ? profile.role : 'user' };
        // сохранение сессии локально
        DB.set('sessions', { current: AppState.currentUser });
        await Storage.set('sessions', { current: AppState.currentUser });
        note.innerText = 'Успешно';
        renderMain();
      } catch(e){
        note.innerText = 'Ошибка: ' + e.message;
      }
    };
    box.appendChild(email); box.appendChild(password); box.appendChild(el('div', { style:'margin-top:8px' }, btn)); box.appendChild(note);
    root.appendChild(box);
    return;
  }

  // если зашёл — показать простую панель
  const ubox = el('div', { style:'margin-top:12px' });
  ubox.appendChild(el('h3', {}, `Добро пожаловать, ${AppState.currentUser.username || AppState.currentUser.email}`));
  ubox.appendChild(el('div', { class:'small muted' }, `Роль: ${AppState.currentUser.role || 'user'}`));

  const logout = el('button', { style:'margin-top:8px' }, 'Выйти');
  logout.onclick = async ()=>{
    await supabase.auth.signOut();
    AppState.currentUser = null;
    DB.set('sessions', { current: null });
    await Storage.set('sessions', { current: null });
    renderMain();
  };
  ubox.appendChild(el('div', { style:'margin-top:8px' }, logout));
  root.appendChild(ubox);

  // show some synced keys
  const keysToShow = ['users','tests','categories','logs','sessions'];
  const table = el('table', { style:'margin-top:12px' });
  const head = el('tr'); head.appendChild(el('th',{},'Ключ')); head.appendChild(el('th',{},'Наличие локально')); head.appendChild(el('th',{},'Прим. действий'));
  table.appendChild(head);
  for (const k of keysToShow) {
    const tr = el('tr');
    tr.appendChild(el('td', {}, k));
    tr.appendChild(el('td', {}, JSON.stringify(DB.get(k) !== null)));
    const btn = el('button', { class:'tiny' }, 'Удалить локально');
    btn.onclick = async ()=>{ DB.set(k, null); localStorage.removeItem(k); await Storage.set(k, null); alert('Удалено локально'); renderMain(); };
    const td = el('td'); td.appendChild(btn);
    tr.appendChild(td);
    table.appendChild(tr);
  }
  root.appendChild(table);

  // quick: show "tests" content
  const tests = loadTests();
  const dump = el('pre', { style:'margin-top:12px; white-space:pre-wrap' }, JSON.stringify(tests, null, 2));
  root.appendChild(dump);
}

/* ===================== Startup: sync and subscribe ===================== */
(async function start(){
  // 1) load local defaults if nothing
  // create default admin in local (only local fallback) for compatibility with existing flows
  const usersLocal = await _storageGet('users');
  if (!usersLocal) {
    const h = await hashHex('admin123');
    await Storage.set('users', [{ username:'admin', passwordHash: h, role:'admin', active:true }]);
    DB.set('users', [{ username:'admin', passwordHash: h, role:'admin', active:true }]);
  }

  // 2) subscribe to supabase realtime (если есть URL/KEY)
  try {
    subscribeToApp();
    // 3) seed local from supabase if supabase has data
    await initialLoadFromSupabase();
  } catch(e){ console.warn('Supabase init warning', e); }

  // 4) restore session
  try {
    const sess = await _storageGet('sessions');
    if (sess && sess.current) AppState.currentUser = sess.current;
  } catch(e){}

  // render UI
  renderMain();
})();
</script>
</body>
</html>
